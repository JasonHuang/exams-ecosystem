# 系统架构

## 🏗️ 整体架构

小学数学练习生成器生态系统采用现代化的微服务架构，基于 Monorepo 管理多个相关项目。

```
┌─────────────────────────────────────────────────────────────┐
│                    用户层 (User Layer)                      │
├─────────────────────┬─────────────────────┬─────────────────┤
│    Web浏览器        │    微信小程序        │    移动端浏览器   │
│   (Next.js Web)     │  (Mini Program)     │   (响应式Web)    │
└─────────────────────┴─────────────────────┴─────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   应用层 (Application Layer)                │
├─────────────────────┬─────────────────────┬─────────────────┤
│    前端应用         │    小程序端         │    管理后台      │
│   (@exams/web)      │ (@exams/miniprogram)│   (未来规划)     │
└─────────────────────┴─────────────────────┴─────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Service Layer)                    │
├─────────────────────┬─────────────────────┬─────────────────┤
│    API服务          │    共享服务         │    第三方服务    │
│   (@exams/api)      │  (@exams/shared)    │   (微信API等)    │
└─────────────────────┴─────────────────────┴─────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   数据层 (Data Layer)                       │
├─────────────────────┬─────────────────────┬─────────────────┤
│    关系数据库       │    缓存数据库       │    文件存储      │
│   (PostgreSQL)      │     (Redis)         │   (本地/云存储)  │
└─────────────────────┴─────────────────────┴─────────────────┘
```

## 🔧 技术栈

### 前端技术
- **框架**: Next.js 14 (React 18)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **UI组件**: Radix UI
- **状态管理**: Zustand
- **构建工具**: Webpack (Next.js内置)

### 后端技术
- **框架**: Next.js API Routes
- **语言**: TypeScript
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **认证**: JWT + bcryptjs
- **日志**: Winston

### 小程序技术
- **框架**: 微信小程序原生
- **语言**: TypeScript
- **构建**: 微信开发者工具

### 共享技术
- **语言**: TypeScript
- **包管理**: npm workspaces
- **代码规范**: ESLint + Prettier
- **版本控制**: Git

## 📦 包架构

### @exams/shared
**职责**: 提供共享的类型定义、工具函数和业务逻辑

```typescript
shared/
├── src/
│   ├── types/          # 类型定义
│   │   └── index.ts    # 统一导出所有类型
│   ├── utils/          # 工具函数
│   │   └── index.ts    # 数学计算、格式化等工具
│   ├── generators/     # 题目生成器
│   │   └── index.ts    # 各种数学题目生成算法
│   ├── constants/      # 常量定义
│   │   └── index.ts    # 年级配置、难度配置等
│   └── index.ts        # 包的主入口
├── package.json
└── tsconfig.json
```

**核心模块**:
- **Types**: 定义所有数据结构和接口
- **Generators**: 实现各种数学题目生成算法
- **Utils**: 提供通用工具函数
- **Constants**: 定义系统常量和配置

### @exams/web
**职责**: Web前端应用，提供用户界面和交互

```typescript
web/
├── src/
│   ├── app/            # Next.js App Router
│   │   ├── layout.tsx  # 根布局
│   │   └── page.tsx    # 首页
│   ├── components/     # React组件
│   │   ├── ui/         # 基础UI组件
│   │   └── ...         # 业务组件
│   ├── lib/            # 工具库
│   └── styles/         # 样式文件
├── public/             # 静态资源
├── package.json
├── next.config.js
├── tailwind.config.js
└── tsconfig.json
```

**核心功能**:
- 题目生成界面
- 打印和导出功能
- 响应式设计
- 用户交互

### @exams/api
**职责**: 后端API服务，处理数据存储和业务逻辑

```typescript
api/
├── src/
│   └── app/
│       └── api/        # API路由
│           ├── auth/   # 认证相关
│           ├── users/  # 用户管理
│           ├── problems/ # 题目管理
│           └── ...     # 其他API
├── prisma/             # 数据库配置
│   ├── schema.prisma   # 数据模型
│   └── migrations/     # 数据库迁移
├── package.json
└── tsconfig.json
```

**核心功能**:
- RESTful API
- 用户认证和授权
- 数据持久化
- 缓存管理

### @exams/miniprogram
**职责**: 微信小程序，提供移动端体验

```typescript
miniprogram/
├── miniprogram/        # 小程序源码
│   ├── pages/          # 页面
│   ├── components/     # 组件
│   ├── utils/          # 工具函数
│   └── app.js          # 小程序入口
├── typings/            # 类型定义
├── package.json
└── project.config.json # 小程序配置
```

## 🔄 数据流

### 1. 题目生成流程
```
用户输入参数 → Shared/Generators → 生成题目数据 → 前端渲染 → 用户查看
```

### 2. 用户数据流程
```
用户操作 → Web/MiniProgram → API服务 → 数据库 → 返回结果 → 前端更新
```

### 3. 跨包依赖关系
```
Web ──────┐
          ├──→ Shared ←──┐
MiniProgram ──┘          │
                         │
API ─────────────────────┘
```

## 🚀 部署架构

### 开发环境
- 本地开发服务器
- 热重载和实时编译
- 开发数据库

### 生产环境
- CDN静态资源分发
- 负载均衡
- 数据库集群
- Redis缓存集群
- 监控和日志系统

## 🔒 安全架构

### 认证授权
- JWT Token认证
- 角色权限控制
- API访问限制

### 数据安全
- 数据库连接加密
- 敏感信息脱敏
- 输入验证和过滤

### 网络安全
- HTTPS强制加密
- CORS跨域控制
- 防SQL注入

## 📈 扩展性设计

### 水平扩展
- 无状态API设计
- 数据库读写分离
- 缓存分布式部署

### 功能扩展
- 插件化题目生成器
- 模块化组件设计
- 配置化业务规则

## 🔧 开发工具链

### 代码质量
- TypeScript类型检查
- ESLint代码规范
- Prettier代码格式化
- Husky Git钩子

### 构建部署
- npm workspaces包管理
- Next.js构建优化
- Docker容器化
- CI/CD自动化

这个架构设计确保了系统的可维护性、可扩展性和高性能，同时保持了代码的复用性和一致性。